<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Action Approval Dashboard</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div id="app" class="max-w-5xl mx-auto">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Action Approval</h1>
                <p class="text-gray-600">Review and execute proposed AI actions</p>
            </div>
            <div class="flex items-center gap-2">
                <button v-if="actions.length > 0" @click="dismissAll" class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded transition">
                    Dismiss All
                </button>
                <span class="relative flex h-3 w-3">
                  <span v-if="polling" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                  <span :class="polling ? 'bg-green-500' : 'bg-gray-400'" class="relative inline-flex rounded-full h-3 w-3"></span>
                </span>
                <span class="text-sm text-gray-500">${ polling ? 'Live' : 'Paused' }</span>
            </div>
        </header>

        <div v-if="actions.length === 0" class="text-center py-12 bg-white rounded-lg shadow">
            <i class="fas fa-robot text-4xl text-gray-300 mb-4"></i>
            <p class="text-gray-500">No proposed actions waiting for approval.</p>
        </div>

        <div v-else class="space-y-6">
            <div v-for="action in actions" :key="action.uuid" class="bg-white rounded-lg shadow overflow-hidden border-l-4" 
                 :class="{
                    'border-green-500': action.data.action === 'create',
                    'border-blue-500': action.data.action === 'update',
                    'border-red-500': action.data.action === 'delete',
                    'border-purple-500': action.data.action === 'send_email',
                    'border-orange-500': action.data.action === 'create_jira_issue',
                    'border-teal-500': action.data.action === 'send_slack_message'
                 }">
                
                <div v-if="action.confirmed" class="p-12 text-center bg-green-50 text-green-700 transition-all duration-500 ease-in-out">
                    <i class="fas fa-check-circle text-5xl mb-4"></i>
                    <h3 class="text-xl font-bold">Action Executed</h3>
                    <p class="text-sm opacity-80">Dismissing...</p>
                </div>

                <div v-else>
                <!-- Header -->
                <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                    <div class="flex items-center gap-3">
                        <span class="px-2 py-1 text-xs font-bold uppercase rounded"
                              :class="{
                                'bg-green-100 text-green-800': action.data.action === 'create',
                                'bg-blue-100 text-blue-800': action.data.action === 'update',
                                'bg-red-100 text-red-800': action.data.action === 'delete',
                                'bg-purple-100 text-purple-800': action.data.action === 'send_email',
                                'bg-orange-100 text-orange-800': action.data.action === 'create_jira_issue',
                                'bg-teal-100 text-teal-800': action.data.action === 'send_slack_message'
                              }">
                            ${ action.data.action.replace('_', ' ') }
                        </span>
                        <span class="text-sm text-gray-500 font-mono">${ action.uuid.substring(0, 8) }...</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button @click="action.showRaw = !action.showRaw" class="text-xs text-gray-500 hover:text-gray-700 underline">
                            ${ action.showRaw ? 'Show UI' : 'Show JSON' }
                        </button>
                        <button @click="deleteAction(action.uuid)" class="text-gray-400 hover:text-red-500 transition ml-2">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Body -->
                <div class="p-4">
                    <!-- Raw JSON View -->
                    <div v-if="action.showRaw" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div v-if="action.existing_data || (action.data && action.data.original)" class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Existing Data</label>
                            <div class="w-full h-64 font-mono text-xs p-3 border rounded bg-gray-100 overflow-auto whitespace-pre">${ JSON.stringify(action.existing_data || action.data.original, null, 2) }</div>
                        </div>
                        <div class="mb-4" :class="{'col-span-2': !action.existing_data && !action.data.original}">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Proposed Action Data</label>
                            <textarea 
                                v-model="action.jsonString" 
                                @input="updateJson(action)"
                                class="w-full h-64 font-mono text-sm p-3 border rounded bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                :class="{'border-red-300': action.jsonError}"></textarea>
                            <p v-if="action.jsonError" class="text-red-500 text-xs mt-1">${ action.jsonError }</p>
                        </div>
                    </div>

                    <!-- Human Readable UI -->
                    <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- LEFT COLUMN: Context / Existing -->
                        <div>
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">
                                ${ ['update', 'delete'].includes(action.data.action) ? 'Current State' : 'Context' }
                            </h3>
                            
                            <!-- Calendar Existing Event Card -->
                            <div v-if="action.data.original && ['update', 'delete'].includes(action.data.action)" 
                                 class="bg-gray-50 rounded border p-4 text-sm text-gray-600">
                                <div class="font-bold text-gray-800 text-lg mb-1">${ action.data.original.summary || '(No Title)' }</div>
                                <div class="flex items-center gap-2 mb-1">
                                    <i class="far fa-clock text-gray-400 w-4"></i>
                                    <span>${ formatEventTime(action.data.original) }</span>
                                </div>
                                <div v-if="action.data.original.location" class="flex items-center gap-2 mb-1">
                                    <i class="fas fa-map-marker-alt text-gray-400 w-4"></i>
                                    <span>${ action.data.original.location }</span>
                                </div>
                                <div v-if="action.data.original.description" class="mt-2 p-2 bg-gray-100 rounded text-xs whitespace-pre-wrap">
                                    ${ action.data.original.description }
                                </div>
                            </div>
                            
                            <!-- Empty State for Create/Email -->
                            <div v-else class="h-full flex flex-col items-center justify-center text-gray-400 border-2 border-dashed border-gray-200 rounded-lg p-6">
                                <i class="fas fa-plus-circle text-3xl mb-2 opacity-20"></i>
                                <span class="text-sm">New Item</span>
                            </div>
                        </div>

                        <!-- RIGHT COLUMN: Proposed Changes -->
                        <div>
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Proposed Changes</h3>
                            
                            <!-- CALENDAR FORM -->
                            <div v-if="['create', 'update', 'delete'].includes(action.data.action)" class="bg-white border rounded-lg p-4 shadow-sm relative">
                                <div v-if="action.data.action === 'delete'" class="absolute inset-0 bg-red-50 bg-opacity-90 flex items-center justify-center z-10 rounded-lg">
                                    <div class="text-center text-red-600">
                                        <i class="fas fa-trash-alt text-3xl mb-2"></i>
                                        <p class="font-bold">Deleting Event</p>
                                    </div>
                                </div>

                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Event Title</label>
                                        <input type="text" 
                                               v-model="action.data.body.summary" 
                                               @input="updateFromUi(action)"
                                               class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none font-medium text-gray-800">
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500 mb-1">Start</label>
                                            <input type="datetime-local" 
                                                   :value="toDatetimeLocal(action.data.body.start?.dateTime)"
                                                   @input="updateDateTime(action, 'start', $event.target.value)"
                                                   class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500 mb-1">End</label>
                                            <input type="datetime-local" 
                                                   :value="toDatetimeLocal(action.data.body.end?.dateTime)"
                                                   @input="updateDateTime(action, 'end', $event.target.value)"
                                                   class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Location</label>
                                        <div class="relative">
                                            <i class="fas fa-map-marker-alt absolute left-3 top-2.5 text-gray-400"></i>
                                            <input type="text" 
                                                   v-model="action.data.body.location" 
                                                   @input="updateFromUi(action)"
                                                   class="w-full pl-8 p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Description</label>
                                        <textarea v-model="action.data.body.description" 
                                                  @input="updateFromUi(action)"
                                                  rows="3"
                                                  class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Attendees (comma separated)</label>
                                        <input type="text" 
                                               :value="formatAttendees(action.data.body.attendees)"
                                               @change="updateAttendees(action, $event.target.value)"
                                               placeholder="email@example.com, ..."
                                               class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    </div>
                                </div>
                            </div>

                            <!-- EMAIL FORM -->
                            <div v-else-if="action.data.action === 'send_email'" class="bg-white border rounded-lg p-4 shadow-sm">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">To</label>
                                        <div class="relative">
                                            <i class="fas fa-envelope absolute left-3 top-2.5 text-gray-400"></i>
                                            <input type="email" 
                                                   v-model="action.data.body.recipient" 
                                                   @input="updateFromUi(action)"
                                                   class="w-full pl-8 p-2 border rounded text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Subject</label>
                                        <input type="text" 
                                               v-model="action.data.body.subject" 
                                               @input="updateFromUi(action)"
                                               class="w-full p-2 border rounded font-medium focus:ring-2 focus:ring-purple-500 outline-none">
                                    </div>

                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Message Body</label>
                                        <textarea v-model="action.data.body.body" 
                                                  @input="updateFromUi(action)"
                                                  rows="6"
                                                  class="w-full p-3 border rounded text-sm focus:ring-2 focus:ring-purple-500 outline-none whitespace-pre-wrap font-sans"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- JIRA FORM -->
                            <div v-else-if="action.data.action === 'create_jira_issue'" class="bg-white border rounded-lg p-4 shadow-sm">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Summary</label>
                                        <input type="text" 
                                               v-model="action.data.body.summary" 
                                               @input="updateFromUi(action)"
                                               class="w-full p-2 border rounded font-medium focus:ring-2 focus:ring-orange-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Description</label>
                                        <textarea v-model="action.data.body.description" 
                                                  @input="updateFromUi(action)"
                                                  rows="4"
                                                  class="w-full p-3 border rounded text-sm focus:ring-2 focus:ring-orange-500 outline-none whitespace-pre-wrap font-sans"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- SLACK FORM -->
                            <div v-else-if="action.data.action === 'send_slack_message'" class="bg-white border rounded-lg p-4 shadow-sm">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Message</label>
                                        <textarea v-model="action.data.body.message" 
                                                  @input="updateFromUi(action)"
                                                  rows="4"
                                                  class="w-full p-3 border rounded text-sm focus:ring-2 focus:ring-teal-500 outline-none whitespace-pre-wrap font-sans"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Fallback for unknown types -->
                             <div v-else class="p-4 bg-yellow-50 text-yellow-800 rounded border border-yellow-200">
                                Unknown action type. Please use "Show JSON" to edit.
                             </div>

                        </div>
                    </div>

                    <!-- Execution Result Display -->
                    <div v-if="action.executionResult" class="mt-4 p-4 bg-gray-50 border-t">
                         <label class="block text-sm font-medium text-gray-700 mb-1">Execution Result</label>
                         <div class="w-full p-3 bg-white border rounded text-sm font-mono overflow-auto max-h-48">
                            ${ JSON.stringify(action.executionResult.result || action.executionResult, null, 2) }
                         </div>
                    </div>

                    <div class="flex justify-end gap-3 mt-6 pt-4 border-t" v-if="!action.executionResult">
                        <button @click="executeAction(action)" 
                                :disabled="!!action.jsonError || action.executing"
                                class="px-6 py-2 bg-blue-600 text-white font-medium rounded shadow-sm hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 transition transform active:scale-95">
                            <i v-if="action.executing" class="fas fa-circle-notch fa-spin"></i>
                            <i v-else class="fas fa-paper-plane"></i>
                            ${ action.data.action === 'send_email' ? 'Send Email' : 
                               action.data.action === 'create_jira_issue' ? 'Create Issue' :
                               action.data.action === 'send_slack_message' ? 'Send Message' : 'Confirm Action' }
                        </button>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            delimiters: ['${', '}'],
            data() {
                return {
                    actions: [],
                    polling: true,
                    pollInterval: null
                }
            },
            mounted() {
                this.fetchActions()
                this.pollInterval = setInterval(this.fetchActions, 2000)
            },
            methods: {
                async fetchActions() {
                    if (!this.polling) return;
                    try {
                        const res = await fetch('/actions');
                        const data = await res.json();
                        
                        const newActionsMap = new Map(data.map(a => [a.uuid, a]));
                        
                        // Remove actions that no longer exist
                        this.actions = this.actions.filter(a => newActionsMap.has(a.uuid));

                        // Add new actions
                        for (const [uuid, serverAction] of newActionsMap) {
                            const existing = this.actions.find(a => a.uuid === uuid);
                            if (!existing) {
                                // Ensure body structure exists for binding
                                if (!serverAction.data.body) serverAction.data.body = {};
                                
                                this.actions.push({
                                    ...serverAction,
                                    jsonString: JSON.stringify(serverAction.data, null, 2),
                                    jsonError: null,
                                    executing: false,
                                    executionResult: null,
                                    showRaw: false
                                });
                            }
                        }
                    } catch (e) {
                        console.error("Failed to fetch actions", e);
                    }
                },
                updateJson(action) {
                    try {
                        const parsed = JSON.parse(action.jsonString);
                        action.data = parsed;
                        action.jsonError = null;
                        this.saveAction(action);
                    } catch (e) {
                        action.jsonError = e.message;
                    }
                },
                updateFromUi(action) {
                    action.jsonString = JSON.stringify(action.data, null, 2);
                    this.saveAction(action);
                },
                async saveAction(action) {
                    if (action.jsonError) return;
                    try {
                        await fetch(`/actions/${action.uuid}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ data: action.data })
                        });
                    } catch (e) {
                        console.error("Failed to save", e);
                    }
                },
                async deleteAction(uuid) {
                    if (!confirm('Are you sure you want to dismiss this action?')) return;
                    try {
                        await fetch(`/actions/${uuid}`, { method: 'DELETE' });
                        this.actions = this.actions.filter(a => a.uuid !== uuid);
                    } catch (e) {
                        console.error("Failed to delete", e);
                    }
                },
                async dismissAll() {
                    if (!confirm('Are you sure you want to dismiss ALL actions?')) return;
                    try {
                        // Delete all actions sequentially (or could add a bulk endpoint)
                        const promises = this.actions.map(a => fetch(`/actions/${a.uuid}`, { method: 'DELETE' }));
                        await Promise.all(promises);
                        this.actions = [];
                    } catch (e) {
                        console.error("Failed to dismiss all", e);
                    }
                },
                async executeAction(action) {
                    if (action.jsonError) return;
                    action.executing = true;
                    try {
                        const res = await fetch(`/actions/${action.uuid}/execute`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ data: action.data }) 
                        });
                        const result = await res.json();
                        
                        if (result.status === 'success') {
                            action.executionResult = result.result;
                            action.confirmed = true;
                            setTimeout(() => {
                                this.actions = this.actions.filter(a => a.uuid !== action.uuid);
                            }, 2000);
                        } else {
                            alert('Error executing action: ' + result.message);
                        }
                    } catch (e) {
                        console.error("Failed to execute", e);
                        alert('Failed to execute action');
                    } finally {
                        action.executing = false;
                    }
                },
                // Helpers
                toDatetimeLocal(iso) {
                    if (!iso) return '';
                    // Handle "2023-10-27T10:00:00-07:00" -> "2023-10-27T10:00"
                    return iso.substring(0, 16);
                },
                updateDateTime(action, field, value) {
                    if (!action.data.body[field]) action.data.body[field] = {};
                    // Append seconds and maybe timezone if needed, but for now simple ISO
                    action.data.body[field].dateTime = value + ':00';
                    this.updateFromUi(action);
                },
                formatEventTime(event) {
                    if (!event.start) return '';
                    const start = event.start.dateTime || event.start.date;
                    const end = event.end.dateTime || event.end.date;
                    if (!start) return '';
                    
                    const d = new Date(start);
                    return d.toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' });
                },
                formatAttendees(attendees) {
                    if (!attendees || !Array.isArray(attendees)) return '';
                    return attendees.map(a => a.email).join(', ');
                },
                updateAttendees(action, value) {
                    const emails = value.split(',').map(e => e.trim()).filter(e => e);
                    action.data.body.attendees = emails.map(e => ({ email: e }));
                    this.updateFromUi(action);
                }
            }
        }).mount('#app')
    </script>
</body>
</html>